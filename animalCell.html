




<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JCE Biology AR - Pro Lab</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: black; }
        #arjs-video { position: absolute !important; top: 0 !important; left: 0 !important; z-index: -1 !important; }
        #ui-layer { position: fixed; inset: 0; pointer-events: none; z-index: 1000; }
        .interactable-ui { pointer-events: auto; }
        
        #overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; z-index: 2000; text-align: center;
        }

        #status-label {
            position: absolute; left: 10px; top: 10px; padding: 6px 12px;
            background: rgba(0,0,0,0.8); color: #00ff00; border-radius: 20px;
            font-size: 11px; border: 1px solid #00ff00;
        }

        #gps-display {
            position: absolute; left: 10px; top: 55px; padding: 10px;
            background: rgba(0,0,0,0.85); color: #00ff00; border-radius: 8px;
            font-size: 10px; border: 1px solid #00ff00; display: none;
        }

        #teacher-panel {
            position: absolute; top: 10px; right: 10px;
            background: rgba(20,20,20,0.95); padding: 10px;
            border-radius: 12px; width: 165px; border: 2px solid #800000;
        }

        .teacher-btn {
            width: 100%; margin: 4px 0; padding: 10px; border-radius: 8px;
            background: #800000; color: white; border: 1px solid orange;
            font-size: 10px; font-weight: bold; cursor: pointer;
        }

        #help-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: white; padding: 15px 25px;
            border-radius: 30px; width: 85%; text-align: center;
            border: 1px solid #00ff00; font-size: 13px; pointer-events: auto;
        }
    </style>
</head>

<body>

<div id="overlay" class="interactable-ui">
    <h2>JCE Biology AR</h2>
    <p>3D Environment & GPS Lab</p>
    <button class="teacher-btn" style="width:200px;font-size:16px" onclick="startApp()"> START AR</button>
</div>

<div id="ui-layer">
    <div id="status-label">MODE: HIRO MARKER</div>

    <div id="gps-display">
        <b style="color:white"> LIVE GPS</b><br>
        Lat: <span id="lat">0.0000</span> | Lon: <span id="lon">0.0000</span>
    </div>
    
    <div id="teacher-panel" class="interactable-ui">
        <button class="teacher-btn" onclick="cycleMode()"> SWITCH MODE</button>
        <button class="teacher-btn" style="background:#2b5797" onclick="toggleLabels()"> TOGGLE INFO</button>
        <button class="teacher-btn" style="background:#1a5e1a" onclick="toggleCellType()"> ANIMAL/PLANT</button>
        <button class="teacher-btn" style="background:#cc6600" onclick="resetApp()"> RESET ALL</button>
        <button id="gps-action-btn" class="teacher-btn" style="display:none;background:#004d00" onclick="dropAtCurrentLocation()"> ANCHOR HERE</button>
        <button class="teacher-btn" onclick="adjustScale(1.1)"> SCALE</button>
        <button class="teacher-btn" onclick="adjustScale(0.9)"> SCALE</button>
    </div>

    <div id="help-bar" class="interactable-ui" onclick="placeFreeRoam()">Point at Hiro Marker</div>
</div>

<a-scene
    id="mainScene"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
    renderer="antialias: true; alpha: true; preserveDrawingBuffer: true;"
    vr-mode-ui="enabled: false">

    <a-camera id="cam" gps-camera rotation-reader></a-camera>

    <a-entity id="animalTemplate" visible="false">
        <a-sphere radius="2.2" material="color:#4cc9f0;opacity:0.15;transparent:true;side:double"></a-sphere>
        <a-sphere radius="0.6" color="#7209b7">
            <a-text class="cell-label" value="NUCLEUS: \n Brain of the cell" position="0 1.2 0" align="center" scale="0.6 0.6 0.6" visible="false"></a-text>
        </a-sphere>
        <a-entity position="1.3 0.6 0.5">
            <a-sphere radius="0.25" scale="1.5 0.6 0.6" color="#f72585"></a-sphere>
            <a-text class="cell-label" value="MITOCHONDRIA: \n Powerhouse" position="0 -0.5 0" align="center" scale="0.5 0.5 0.5" visible="false"></a-text>
        </a-entity>
        <a-text value="ANIMAL CELL" position="0 2.8 0" align="center" color="#00ff00" width="6"></a-text>
    </a-entity>

    <a-entity id="plantTemplate" visible="false">
        <a-box width="3.4" height="4.4" depth="3.4" material="color:#004d00;opacity:0.25;transparent:true;side:double"></a-box>
        <a-box width="1.8" height="2.8" depth="1.8" color="#ade8f4" position="0 -0.2 0" opacity="0.45">
            <a-text class="cell-label" value="VACUOLE: \n Water Storage" position="0 1.8 0" align="center" scale="0.7 0.7 0.7" visible="false"></a-text>
        </a-box>
        <a-entity position="-1.2 1.2 0.8">
            <a-sphere radius="0.3" scale="1 0.4 1" color="#228b22"></a-sphere>
            <a-text class="cell-label" value="CHLOROPLAST: \n Photosynthesis" position="0 -0.6 0" align="center" scale="0.5 0.5 0.5" visible="false"></a-text>
        </a-entity>
        <a-text value="PLANT CELL" position="0 3.2 0" align="center" color="#74c69d" width="6"></a-text>
    </a-entity>

    <a-ring id="reticle" color="#00ff00" radius-inner="0.4" radius-outer="0.5" rotation="-90 0 0" position="0 -1.5 -3" visible="false"></a-ring>

    <a-marker preset="hiro" id="markerTarget">
        <a-entity id="markerContainer" scale="0.3 0.3 0.3"></a-entity>
    </a-marker>

    <a-entity id="gpsTarget" visible="false">
        <a-entity id="gpsContainer" scale="10 10 10"></a-entity>
    </a-entity>

    <a-entity id="freeRoamContainer" position="0 -1.5 -5" visible="false"></a-entity>

</a-scene>

<script>
let modes = ["HIRO MARKER", "GPS ANCHOR", "FREE ROAM"];
let modeIndex = 0;
let labelsVisible = false;
let isPlantCell = false;

function startApp() {
    document.getElementById("overlay").style.display = "none";
    updateCellModels();
    
    // GPS Real-time display
    navigator.geolocation.watchPosition(p => {
        document.getElementById("lat").textContent = p.coords.latitude.toFixed(4);
        document.getElementById("lon").textContent = p.coords.longitude.toFixed(4);
    }, err => console.log(err), { enableHighAccuracy: true });
}

function updateCellModels() {
    const templateId = isPlantCell ? "plantTemplate" : "animalTemplate";
    const tpl = document.getElementById(templateId);
    
    ["markerContainer", "gpsContainer", "freeRoamContainer"].forEach(id => {
        const container = document.getElementById(id);
        container.innerHTML = ''; 
        const clone = tpl.cloneNode(true);
        clone.setAttribute("visible", "true");
        clone.removeAttribute("id");
        
        // Ensure the cloned labels inherit the current toggle state immediately
        const internalLabels = clone.querySelectorAll('.cell-label');
        internalLabels.forEach(l => l.setAttribute('visible', labelsVisible));
        
        container.appendChild(clone);
    });
}

function toggleLabels() {
    labelsVisible = !labelsVisible;
    // Target all labels currently in the scene
    const allLabels = document.querySelectorAll('.cell-label');
    allLabels.forEach(l => l.setAttribute('visible', labelsVisible));
}

function toggleCellType() {
    isPlantCell = !isPlantCell;
    updateCellModels();
}

function resetApp() {
    document.getElementById("markerContainer").setAttribute("scale", "0.3 0.3 0.3");
    document.getElementById("gpsContainer").setAttribute("scale", "10 10 10");
    document.getElementById("freeRoamContainer").setAttribute("scale", "1 1 1");
    
    document.getElementById("gpsTarget").setAttribute("visible", false);
    document.getElementById("gpsTarget").removeAttribute("gps-entity-place");
    document.getElementById("freeRoamContainer").setAttribute("visible", false);
    
    labelsVisible = false;
    toggleLabels(); // Use function to ensure cleanup
    alert("Reset: Labels hidden & anchors cleared.");
}

function cycleMode() {
    modeIndex = (modeIndex + 1) % modes.length;
    const m = modes[modeIndex];
    document.getElementById("status-label").textContent = "MODE: " + m;
    
    document.getElementById("gps-display").style.display = (m === "GPS ANCHOR") ? "block" : "none";
    document.getElementById("gps-action-btn").style.display = (m === "GPS ANCHOR") ? "block" : "none";
    document.getElementById("reticle").setAttribute("visible", m === "FREE ROAM");

    document.getElementById("markerTarget").setAttribute("visible", m === "HIRO MARKER");
    document.getElementById("gpsTarget").setAttribute("visible", (m === "GPS ANCHOR"));
    document.getElementById("freeRoamContainer").setAttribute("visible", (m === "FREE ROAM"));

    document.getElementById("help-bar").textContent = 
        m === "FREE ROAM" ? "Tap bottom bar to place cell on ground" : 
        m === "HIRO MARKER" ? "Point at Hiro Marker" : "Wait for GPS and tap Anchor";
}

function dropAtCurrentLocation() {
    navigator.geolocation.getCurrentPosition(p => {
        const target = document.getElementById("gpsTarget");
        target.setAttribute("gps-entity-place", { 
            latitude: p.coords.latitude, 
            longitude: p.coords.longitude 
        });
        target.setAttribute("visible", true);
        alert("Success: Cell anchored to this spot.");
    });
}

function placeFreeRoam() {
    if (modes[modeIndex] !== "FREE ROAM") return;
    
    const fr = document.getElementById("freeRoamContainer");
    const cam = document.querySelector("#cam");
    
    // Calculate 4 meters in front of current camera view
    const rotation = cam.getAttribute("rotation");
    const angle = (rotation.y) * (Math.PI / 180);
    const x = 4 * Math.sin(angle);
    const z = 4 * Math.cos(angle);

    fr.setAttribute("position", `${-x} -1.5 ${-z}`);
    fr.setAttribute("visible", true);
}

function adjustScale(f) {
    const activeId = (modes[modeIndex] === "HIRO MARKER") ? "markerContainer" : 
                     (modes[modeIndex] === "GPS ANCHOR") ? "gpsContainer" : "freeRoamContainer";
    const el = document.getElementById(activeId);
    const s = el.getAttribute("scale");
    el.setAttribute("scale", { x: s.x * f, y: s.y * f, z: s.z * f });
}
</script>
</body>
</html>